---
title: "Football Statistics"
author: "Peter McNamara"
date: "5th August 2019"
output: word_document
---
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r echo=FALSE, warning=FALSE, message=FALSE, eval=TRUE}
## ---- load_data  ----
library(tidyverse)
library(readr)
library(dplyr)
library(ggplot2)
library(zoo)
library(shiny)
library(scales)

setwd("/GitDev/Footyapp/data/") # use here function instead
FootyGames <- read.csv("FootyGames.csv", stringsAsFactors = FALSE)

footy_match_play <- FootyGames %>% #filter(playNumber == 1) %>%
  group_by(gameID, competition, ourName, theirName, playNumber) %>%
  arrange(gameID, competition, ourName, theirName, playNumber, sequenceNumber) %>%
  summarise(playByUs = first(byUs),
            usPhase = first(usPhase),
            oppositionPhase = first(oppositionPhase),
            firstEvent = first(adjEventName),
            lastEvent = last(adjEventName),
            Area = first(case_when(lengthFraction <= 0.333333 ~ "Defence",
   lengthFraction >= 0.666667 ~ "Attack",
   TRUE ~ "Midfield") ),
            firstEventArea = paste(firstEvent, "-", Area),
            numSequences = max(sequenceNumber),
            numPlayers = max(player),
            isAttackIncursion = max(attackIncursion),
            isPenaltyIncursion = max(penaltyIncursion),
            playPhase = first(ifelse(playByUs == "true", usPhase, oppositionPhase)),
            totalPasses = sum(adjPass),
            playDuration = sum(duration),
            goals = sum(ifelse(adjEventName == "goal", 1, 0)),
            shots = sum(ifelse(adjEventName == "shot", 1, 0)) )

comp <- "2019 NSFA 1 Boys Under 13"
team <- "NFC Red"

footy_match_play <- footy_match_play %>%
  filter(!competition %in%
      c("2019 NSFA 1 Girls Under 16", "2019 Boys Under 14") )

footy_match_play$teamName = ifelse(footy_match_play$playByUs == "true", footy_match_play$ourName, footy_match_play$theirName)
footy_match_play$orderCol <- case_when(footy_match_play$competition == comp & footy_match_play$teamName == team ~ 0,
                                       footy_match_play$competition %in% c("2019 NSFA 1 Boys Under 13",
                                                                           "2019 NSFA 1 Girls Under 16", "2019 Boys Under 14") ~ 1,
                                       footy_match_play$competition=="2019 International Friendly Mens Open" ~ 2,
                                       footy_match_play$competition=="2019 Icc Football Mens Open" ~ 3,
                                       TRUE ~ 4)

## ---- end-of-load_data  ----
```

## Passes Per Minute

The graph below shows the average number of completed passes per minute for each team (total number of passes / minutes in Possession).  Our team is NFC Red.

```{r echo=FALSE, message=FALSE, eval=TRUE, fig.align ="center"}
# All teams 3 passes or less percentage
ggplot(footy_match_play %>% 
         ungroup %>% group_by(teamName, orderCol) %>%
         summarise(ppm = sum(totalPasses)/ (sum(playDuration/60))) ,
aes(x=reorder(teamName, orderCol, FUN=max), y= ppm, fill=teamName) ) +
  geom_bar( stat = "identity", position = "dodge") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none",
        plot.title = element_text(hjust=0.5)) + 
  labs(x = "Team", y = "Passes", 
       title = "Passes Per Minute") 
```

## Passes per Play in Possession

The first chart shows the percentage of plays that have 1-3 passes in them.  For us, abot 80% of plays last 3 passes or less.  Lindfield A and North Sydney have the best retention in the competition and then top flight teams are also included.

The breakdown of all play sequences is then shown for our team with almost half of plays only having 1 pass.

```{r echo=FALSE, message=FALSE, eval=TRUE, fig.align ="center"}

## ---- plot_win_loss ----

# All teams 3 passes or less percentage
ggplot(footy_match_play %>% filter(totalPasses > 0
) %>% 
  mutate(threePass = ifelse(totalPasses < 4, TRUE, FALSE) ) %>%
  group_by(teamName, orderCol) %>% mutate(tp = n() ) %>%
  filter(threePass == TRUE) %>%
  summarise(perc = n() / max(tp), cnt = n(), max_tp = max(tp) ),
aes(x=reorder(teamName, orderCol, FUN=max), y= perc, fill=teamName) ) +
  geom_bar( stat = "identity", position = "dodge") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none",
        plot.title = element_text(hjust=0.5)) + 
  scale_y_continuous(labels = percent_format(accuracy = 1), limits = c(0, 1)) +
labs(x = "Team", y = "Percentage", 
     title = "3 Passes or Less per Play") 

# Our Teams breakdown of plays
ggplot(footy_match_play %>% filter(competition == comp & ourName == team &
                                     totalPasses > 0 & playByUs == "true"
) %>% ungroup() %>% #group_by(ourName) %>%
  mutate(tp = n() ) %>%
  group_by(totalPasses) %>%
  summarise(perc = n() / max(tp), cnt = n(), max_tp = max(tp) ),
aes(x=totalPasses, y= perc) ) +
  geom_bar(stat = "identity", fill = "light blue") +
  geom_text(aes(label=scales::percent(perc)), position = position_stack(vjust = 0.5)) +
    theme(plot.title = element_text(hjust=0.5)) + 
  scale_y_continuous(labels = percent_format(accuracy = 1)) +
labs(x = "Number of Passes", y = "Percentage", 
     title = "Passes per Play - Us") 

```

## Throw Ins

The graph below shows the percentage of plays having 0 or 1 passes per team.  This is then expanded for the 13's.  Also included in Lindfield A who had good retention from the throw in.

```{r echo=FALSE, message=FALSE, eval=TRUE, fig.align ="center"}
# All teams 1pass or less on throw in
ggplot(footy_match_play %>% filter(firstEvent == "throw in"
) %>% 
  mutate(onePass = ifelse(totalPasses < 2, TRUE, FALSE) ) %>%
  group_by(teamName, orderCol) %>% mutate(tp = n() ) %>%
  filter(onePass == TRUE) %>%
  summarise(perc = n() / max(tp), cnt = n(), max_tp = max(tp) ),
aes(x=reorder(teamName, orderCol, FUN=max), y= perc, fill=teamName) ) +
  geom_bar(stat = "identity", position = "dodge") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none", 
        plot.title = element_text(hjust=0.5) ) +
  scale_y_continuous(labels = percent_format(accuracy = 1), limits = c(0, 1)) +
labs(x = "Team", y = "Percentage", 
     title = "1 Pass or Less on Throw Ins") 
```

```{r echo=FALSE, message=FALSE, eval=TRUE, fig.align ="center"}
# Our throw in stats
ggplot(footy_match_play %>% filter(competition == comp & ourName == team &
                                   playByUs == "true" & firstEvent == "throw in"
) %>% ungroup() %>% #group_by(ourName) %>%
  mutate(tp = n() ) %>%
  group_by(totalPasses) %>%
  summarise(perc = n() / max(tp), cnt = n(), max_tp = max(tp) ),
aes(x=totalPasses, y= perc) ) +
  geom_bar(stat = "identity", fill = "light blue") +
  geom_text(aes(label=scales::percent(perc)), position = position_stack(vjust = 1)) +
  theme(plot.title = element_text(hjust=0.5) ) +
  scale_y_continuous(labels = percent_format(accuracy = 1)) +
labs(x = "Number of Passes", y = "Percentage", 
     title = "Passes per Play from a Throw In - Us") 
```

```{r echo=FALSE, message=FALSE, eval=TRUE, fig.align ="center"}
# Lindfield A throw in stats
ggplot(footy_match_play %>% filter(competition == comp & theirName == "Lindfield A" &
                                     playByUs == "false" & firstEvent == "throw in"
) %>% ungroup() %>% #group_by(ourName) %>%
  mutate(tp = n() ) %>%
  group_by(totalPasses) %>%
  summarise(perc = n() / max(tp), cnt = n(), max_tp = max(tp) ),
aes(x=as.factor(totalPasses), y= perc) ) +
  geom_bar(stat = "identity", fill = "paleturquoise3") +
  geom_text(aes(label=scales::percent(perc)), position = position_stack(vjust = 1)) +
  theme(plot.title = element_text(hjust=0.5) ) +
  scale_y_continuous(labels = percent_format(accuracy = 1)) +
labs(x = "Number of Passes", y = "Percentage", 
     title = "Passes per Play from a Throw In - Lindfield A") 

```

## Goal Scoring

For scoring goals, below shows where goals originate from and what was the start.  So first touch means an intercept whilst the ball was in play.  Most of our goals comes from turnovers in the attacking 3rd.

Then there are figures for how all opponents scored against us and then where the top flight teams are scoring from.

```{r echo=FALSE, message=FALSE, eval=TRUE, fig.align ="center"}
# Goals For
ggplot(footy_match_play %>% filter(competition == comp & ourName == team &
                                     playByUs == "true" & lastEvent == "goal"
) %>% ungroup() %>% #group_by(ourName) %>%
  mutate(tp = n() ) %>%
  group_by(firstEventArea) %>%
  summarise(perc = n() / max(tp), cnt = n(), max_tp = max(tp) ),
aes(x=reorder(firstEventArea, -perc, FUN = sum), y= perc) ) +
  geom_bar(stat = "identity", fill = "light blue") +
  geom_text(aes(label=cnt), position = position_stack(vjust = 0.5))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1), plot.title = element_text(hjust=0.5) ) +
  scale_y_continuous(labels = percent_format(accuracy = 1)) +
  labs(x = "First Action and Region", y = "Percentage", 
       title = "Where Goals Start From - Us")
```

```{r echo=FALSE, message=FALSE, eval=TRUE, fig.align ="center"}
# Goals Against
ggplot(footy_match_play %>% filter(competition == comp & ourName == team &
                                     playByUs == "false" & lastEvent == "goal"
) %>% ungroup() %>% #group_by(ourName) %>%
  mutate(tp = n() ) %>%
  group_by(firstEventArea) %>%
  summarise(perc = n() / max(tp), cnt = n(), max_tp = max(tp) ),
aes(x=reorder(firstEventArea, -perc, FUN = sum), y= perc) ) +
  geom_bar(stat = "identity", fill = "lightgreen") +
  geom_text(aes(label=cnt), position = position_stack(vjust = 0.5))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1), plot.title = element_text(hjust=0.5) ) +
  scale_y_continuous(labels = percent_format(accuracy = 1)) +
  labs(x = "First Action and Region", y = "Percentage", 
       title = "Where Goals Start From - Opposition")
```

```{r echo=FALSE, message=FALSE, eval=TRUE, fig.align ="center"}
# Goals - Top Level
ggplot(footy_match_play %>% filter(competition != comp & lastEvent == "goal"
) %>% ungroup() %>% #group_by(ourName) %>%
  mutate(tp = n() ) %>%
  group_by(firstEventArea) %>%
  summarise(perc = n() / max(tp), cnt = n(), max_tp = max(tp), avePass = max(totalPasses) / cnt ),
aes(x=reorder(firstEventArea, -perc, FUN = sum), y= perc) ) +
  geom_bar(stat = "identity", fill = "salmon") +
  geom_text(aes(label=cnt), position = position_stack(vjust = 0.5))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1), plot.title = element_text(hjust=0.5) ) +
  scale_y_continuous(labels = percent_format(accuracy = 1)) +
  labs(x = "First Action and Region", y = "Percentage", 
       title = "Where Goals Start From - Top Flight Teams")
```

## Penalty Box Incursions

Finally, below shows where incursions into the Penalty Box occur from and the event that started the play.

```{r echo=FALSE, message=FALSE, eval=TRUE, fig.align ="center"}
# Penalty Incursions For
ggplot(footy_match_play %>% filter(competition == comp & ourName == team &
                                     playByUs == "true" & isPenaltyIncursion == 1 &
                                     totalPasses > 0
) %>% ungroup() %>% #group_by(ourName) %>%
  mutate(tp = n() ) %>%
  group_by(firstEventArea) %>%
  summarise(perc = n() / max(tp), cnt = n(), max_tp = max(tp) ),
aes(x=reorder(firstEventArea, -perc, FUN = sum), y= perc) ) +
  geom_bar(stat = "identity", fill = "light blue") +
  geom_text(aes(label=cnt), position = position_stack(vjust = 0.5))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1), plot.title = element_text(hjust=0.5) ) +
  scale_y_continuous(labels = percent_format(accuracy = 1)) +
  labs(x = "First Action and Region", y = "Percentage", 
       title = "Where Penalty Incursions Start From - Us")


# Penalty Incursions Against
ggplot(footy_match_play %>% filter(competition == comp & ourName == team &
                                     playByUs == "false" & isPenaltyIncursion == 1 &
                                     totalPasses > 0
) %>% ungroup() %>% #group_by(ourName) %>%
  mutate(tp = n() ) %>%
  group_by(firstEventArea) %>%
  summarise(perc = n() / max(tp), cnt = n(), max_tp = max(tp) ),
aes(x=reorder(firstEventArea, -perc, FUN = sum), y= perc) ) +
  geom_bar(stat = "identity", fill = "lightgreen") +
  geom_text(aes(label=cnt), position = position_stack(vjust = 0.5))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1), plot.title = element_text(hjust=0.5) ) +
  scale_y_continuous(labels = percent_format(accuracy = 1)) +
  labs(x = "First Action and Region", y = "Percentage",
       title = "Where Penalty Incursions Start From - Opposition")
```

```{r echo=FALSE, message=FALSE, eval=TRUE, fig.align ="center"}
# Penalty Incursions - Top Level
ggplot(footy_match_play %>% filter(competition != comp & isPenaltyIncursion == 1 &
                                     totalPasses > 0
) %>% ungroup() %>% #group_by(ourName) %>%
  mutate(tp = n() ) %>%
  group_by(firstEventArea) %>%
  summarise(perc = n() / max(tp), cnt = n(), max_tp = max(tp), avePass = max(totalPasses) / cnt ),
aes(x=reorder(firstEventArea, -perc, FUN = sum), y= perc) ) +
  geom_bar(stat = "identity", fill = "salmon") +
  geom_text(aes(label=cnt), position = position_stack(vjust = 0.5))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1), plot.title = element_text(hjust=0.5) ) +
  scale_y_continuous(labels = percent_format(accuracy = 1)) +
  labs(x = "First Action and Region", y = "Percentage", 
       title = "Where Penalty Incursions Start From - Top Flight Teams")
```